generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Jar {
  id            String   @id @default(uuid())
  referenceCode String   @unique
  name          String   @default("Our Jar")
  type          JarType  @default(SOCIAL)
  selectionMode SelectionMode @default(RANDOM)
  topic         String?  @default("General") // e.g. "Movies", "Food"
  voteCandidatesCount Int @default(0) // 0 = All ideas, >0 = Shortlist/Runoff count

  customCategories Json? // Array of { id: string, label: string }
  
  members       JarMember[]
  ideas         Idea[]
  


  location      String?  // e.g. "New York, NY" or "London, UK"
  createdAt     DateTime @default(now())
  isPremium     Boolean  @default(false)
  isTrialEligible Boolean @default(true)
  
  // Community / Public Jar Fields
  // Subscription Fields (Platform / Community)
  stripeCustomerId String?
  stripeSubscriptionId String?
  subscriptionStatus String? // "active", "trialing", "past_due", "canceled"
  subscriptionRenewsAt DateTime?
  
  isLegacyPremium Boolean @default(false) // For grandfathering existing users
  
  // Gamification
  xp          Int      @default(0)
  level       Int      @default(1)
  
  // Streak Tracking
  lastActiveDate    DateTime?
  currentStreak     Int      @default(0)
  longestStreak     Int      @default(0)

  deletedLogs   DeletedLog[]
  favorites     FavoriteVenue[]
  achievements  UnlockedAchievement[]
  voteSessions  VoteSession[]
}

model UnlockedAchievement {
  id            String   @id @default(uuid())
  jarId         String
  achievementId String
  unlockedAt    DateTime @default(now())
  jar           Jar      @relation(fields: [jarId], references: [id])

  @@unique([jarId, achievementId])
}

model DeletedLog {
  id          String   @id @default(uuid())
  jarId       String
  jar         Jar      @relation(fields: [jarId], references: [id])
  description String
  deletedBy   String   // Name of the user who deleted it
  deletedAt   DateTime @default(now())
}

model JarMember {
  id        String     @id @default(uuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  jarId     String
  jar       Jar        @relation(fields: [jarId], references: [id])
  role      MemberRole @default(MEMBER)
  status    MemberStatus @default(ACTIVE)
  joinedAt  DateTime   @default(now())

  @@unique([userId, jarId])
  @@index([userId])              // Speeds up "user's jars" queries
  @@index([status])              // Speeds up filtering active members
}

model User {
  id                    String           @id @default(uuid())
  email                 String           @unique
  name                  String
  passwordHash          String?
  mustChangePassword    Boolean          @default(false)
  
  // Legacy single-jar support (for backward compatibility)

  
  createdAt             DateTime         @default(now())
  homeTown              String?
  interests             String?
  hasUsedTrial          Boolean          @default(false) // Track if they used the 14-day trial
  
  emailVerified         DateTime?
  verificationToken     String?
  
  passwordResetToken    String?
  passwordResetTokenExp DateTime?

  // Managing "Active" Jar
  activeJarId           String?          // The jar they are currently viewing
  
  // Platform-wide Subscription (User level)
  isLifetimePro         Boolean          @default(false) // Manual override / Lifetime purchase
  isSuperAdmin          Boolean          @default(false) // Platform super admin (founder/admin access)
  stripeCustomerId      String?          @unique
  stripeSubscriptionId  String?          @unique
  subscriptionEndsAt    DateTime?
  subscriptionStatus    String?          // "active", "trialing", "past_due", "canceled"

  premiumInviteToken    String?          // Token they can share to invite friends to their pro jars

  image                 String?          // User avatar

  accounts              Account[]
  sessions              Session[]
  
  // Relationships
  memberships           JarMember[]
  createdIdeas          Idea[]           @relation("CreatedBy")
  assignedTasks         Idea[]           @relation("AssignedTo")
  ratings               Rating[]
  votes                 Vote[]
  favorites             FavoriteVenue[]
  appReviews            AppReview[]
  analyticsEvents       AnalyticsEvent[]
  pushSubscriptions     PushSubscription[]
  rateLimit             RateLimit?
  
  // Notification Preferences
  notifyStreakReminder  Boolean @default(true)   // 8pm daily reminder if inactive
  notifyAchievements    Boolean @default(true)   // Achievement unlock notifications
  notifyLevelUp         Boolean @default(true)   // Level-up notifications
  notifyIdeaAdded       Boolean @default(true)   // When someone adds an idea to shared jar
  notifyJarSpun         Boolean @default(true)   // When someone spins the jar
  notifyVoting          Boolean @default(true)   // When a voting session starts or ends
  
  // ✅ NEW: Premium invite tokens created by this user
  createdPremiumTokens  PremiumInviteToken[] @relation("TokenCreator")
  usedPremiumToken      PremiumInviteToken?  @relation("TokenUser")
}

// ✅ HIGH PRIORITY FIX: Secure premium token system
model PremiumInviteToken {
  id            String   @id @default(uuid())
  token         String   @unique // The actual token string
  
  // Security & Limits
  createdById   String
  createdBy     User     @relation("TokenCreator", fields: [createdById], references: [id])
  expiresAt     DateTime // Token expiration date
  maxUses       Int      @default(1) // How many times it can be used
  currentUses   Int      @default(0) // How many times it's been used
  isActive      Boolean  @default(true) // Can be manually deactivated
  
  // Usage Tracking
  usedById      String?  @unique
  usedBy        User?    @relation("TokenUser", fields: [usedById], references: [id])
  usedAt        DateTime?
  
  // Metadata
  notes         String?  // e.g., "Gift for Sarah", "Black Friday special"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([token])
  @@index([createdById])
  @@index([expiresAt])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model Idea {
  id             String   @id @default(uuid())
  description    String
  indoor         Boolean // true = indoor, false = outdoor
  duration       Float // 0.25, 0.5, 0.75, 1.0
  activityLevel  String // LOW, MEDIUM, HIGH
  cost           String // FREE, $, $$, $$$
  timeOfDay      String   @default("ANY") // DAY, EVENING, ANY
  category       String   @default("ACTIVITY") // ACTIVITY, MEAL, EVENT
  
  jarId          String
  jar            Jar      @relation(fields: [jarId], references: [id])
  
  createdById    String
  createdBy      User     @relation("CreatedBy", fields: [createdById], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  selectedAt     DateTime? // If null, it's still in the jar
  selectedDate   DateTime? // The actual date they went on (optional)
  rating         Int?      // 1-5 stars (Legacy/Average)
  notes          String?   // "Best pizza ever!"
  details        String?   // "Wear comfortable shoes", "Bring a swimsuit"
  
  // Rich Data Fields
  address        String?
  website        String?
  googleRating   Float?
  openingHours   String?
  photoUrls      String[]
  
  isSurprise     Boolean  @default(false)
  isPrivate      Boolean  @default(false)

  // Real-life Context
  weather        String   @default("ANY") // ANY, SUNNY, RAINY, COLD
  requiresTravel Boolean  @default(false) // If true, it's an "Outing"
  status         IdeaStatus @default(APPROVED)

  assignedToId   String?
  assignedTo     User?    @relation("AssignedTo", fields: [assignedToId], references: [id])

  ratings        Rating[]
  wonSessions    VoteSession[] @relation("SessionWinner")
  votes          Vote[]
  
  memoryReminderSent Boolean @default(false)

  @@index([jarId, selectedAt])  // Speeds up "available ideas" queries
  @@index([createdById])         // Speeds up "user's ideas" lookups
  @@index([status])              // Speeds up filtering by approval status
  @@index([jarId, status, selectedAt])  // Composite for complex filters
}

model Rating {
  id        String   @id @default(uuid())
  ideaId    String
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  value     Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ideaId, userId])
}

model FavoriteVenue {
  id          String   @id @default(uuid())
  jarId       String
  jar         Jar      @relation(fields: [jarId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  name        String
  address     String?
  description String?
  websiteUrl  String?
  googleRating Float?
  type        String   @default("VENUE") // VENUE, RESTAURANT, ACTIVITY
  createdAt   DateTime @default(now())
  isShared    Boolean  @default(false)

  @@index([jarId])
}

model VoteSession {
  id              String         @id @default(uuid())
  jarId           String
  jar             Jar            @relation(fields: [jarId], references: [id])
  
  status          VoteStatus     @default(ACTIVE)
  startTime       DateTime       @default(now())
  endTime         DateTime?
  tieBreakerMode  TieBreakerMode @default(RANDOM_PICK)
  round           Int            @default(1)
  
  winnerId        String?
  winner          Idea?          @relation("SessionWinner", fields: [winnerId], references: [id])
  
  eligibleIdeaIds String[]       // If empty, all available ideas in jar are eligible
  
  votes           Vote[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model Vote {
  id        String   @id @default(uuid())
  sessionId String
  session   VoteSession @relation(fields: [sessionId], references: [id])
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  ideaId    String
  idea      Idea     @relation(fields: [ideaId], references: [id])
  
  createdAt DateTime @default(now())

  @@unique([sessionId, userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AppReview {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  comment   String
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model AICache {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String //@db.Text
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model RateLimit {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  count     Int      @default(0)
  windowStart DateTime @default(now())
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  type      String   // 'page_view', 'click', 'spin', 'vote', etc.
  name      String   // 'view_dashboard', 'spin_jar', etc.
  value     Float?   // Optional numeric value (e.g., duration, count)
  path      String?
  sessionId String?
  metadata  Json?    // Flexible JSON for event details
  
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([createdAt])
  @@index([type, name])
}


enum JarType {
  ROMANTIC // Date ideas (Couple)
  SOCIAL   // Hangouts (Friends)
  FAMILY   // Family activities
  SOLO     // Self-care / Personal goals
  WORK     // Team building
  GENERIC  // Custom
}

enum SelectionMode {
  RANDOM
  VOTE     @map("VOTING") // Database has VOTING
  WHEEL    // Not in DB?
  ALLOCATION
  ADMIN_PICK
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum MemberStatus {
  INVITED
  ACTIVE
  INACTIVE
  PENDING
  WAITLISTED
}

enum IdeaStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
  PENDING
}

enum VoteStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum TieBreakerMode {
  RANDOM_PICK
  RE_VOTE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  EXPIRED
}
